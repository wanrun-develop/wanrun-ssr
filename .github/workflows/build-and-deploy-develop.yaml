name: Build And Deploy To Lambda

on:
  push:
    branches:
      - hoge
    #   - develop
    paths:
      - "lambda_handler/**"
  workflow_dispatch:
    inputs:
      branch:
        description: "Select branch to deploy"
        required: true
        default: "main"
        type: choice
        options:
          - main

env:
  # lambda
  LAMBDA_FUNCTION_NAME: wr-${{ vars.ENV }}-wanrun-ssr

  # webapp s3
  WEBAPP_S3_BUCKET_NAME: wr-${{ vars.ENV }}-webapp

  # webapp artifact s3
  WEBAPP_ARTIFACT_S3_BUCKET_NAME: wr-global-webapp-artifact-${{ vars.DEVELOP_AWS_ACCOUNT }}
  
  # aws
  AWS_REGION: ap-northeast-1
  AWS_ROLE_ARN: arn:aws:iam::${{ vars.DEVELOP_AWS_ACCOUNT }}:role/github-actions

jobs:
  go-build:
    name: Lambda-build-and-deploy
    runs-on: ubuntu-latest
    permissions: 
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download server files from S3
        run: |
          aws s3 cp s3://${{ env.WEBAPP_S3_BUCKET_NAME }}/server/ server/ --recursive
          aws s3 cp s3://${{ env.WEBAPP_S3_BUCKET_NAME }}/standalone/ standalone/ --recursive

      - name: Install Zip
        run: |
          sudo apt update
          sudo apt install -y zip

      - name: Setup Node
        uses: actions/setup-node@v4.2.0
        with:
          node-version: 20.14.0 # https://github.com/actions/node-versions/releases
          cache: yarn
  
      # Lambda内のnext実行用
      - name: Dependency Install
        run: yarn install --frozen-lockfile

      - name: Create ZIP file
        run: |
          mv lambda_handler/index.js .
          zip -r lambda.zip index.js server/ standalone/ node_modules/

      # バージニア北部リージョン (us-east-1) の認証情報を設定
      - name: Configure AWS credentials for Virginia
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}          
          aws-region: us-east-1

      # アーティファクトをS3にアップロード(サイズが大きいため)
      - name: Upload Lambda ZIP to S3
        run: aws s3 cp lambda.zip s3://${{ env.WEBAPP_ARTIFACT_S3_BUCKET_NAME }}/${{ vars.ENV }}/lambda.zip

      # s3経由でLambdaの更新
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --s3-bucket ${{ env.WEBAPP_ARTIFACT_S3_BUCKET_NAME }} \
            --s3-key ${{ vars.ENV }}/lambda.zip

      # - name: Upload new Lambda version
      #   run: |
      #     # ZIP ファイルをアップロード
      #     aws lambda update-function-code \
      #       --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
      #       --zip-file fileb://lambda.zip

          # 新しいバージョンを発行
          # VERSION=$(aws lambda publish-version --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --query Version --output text)
          
          # echo "New Lambda version: $VERSION"
